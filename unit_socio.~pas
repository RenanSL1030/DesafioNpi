unit unit_socio;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Buttons, BitBtn1, DB, ADODB;

type
  Tform_socios = class(TForm)
    edt_nome: TEdit;
    edt_renda: TEdit;
    rd_ativo: TRadioButton;
    btn_novo: TBitBtn1;
    btn_alterar: TBitBtn1;
    btn_excluir: TBitBtn1;
    Label1: TLabel;
    Label2: TLabel;
    ADOQuery_aux: TADOQuery;
    btn_localizar: TBitBtn1;
    btn_salvar: TBitBtn1;
    btn_cancelar: TBitBtn1;
    rd_inativo: TRadioButton;
    procedure edt_nomeKeyPress(Sender: TObject; var Key: Char);
    procedure btn_localizarClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btn_novoClick(Sender: TObject);
    procedure btn_salvarClick(Sender: TObject);
    procedure btn_alterarClick(Sender: TObject);
    procedure btn_cancelarClick(Sender: TObject);
    procedure btn_excluirClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
        operacao, pk : string;

    procedure desabilita_salvar(Sender : TObject);
    procedure habilita_salvar(Sender : TObject);
    procedure bloqueia_campos;
    procedure libera_campos;
    procedure limpa_campos;
  end;

var
  form_socios: Tform_socios;

implementation

uses unit_menu, unit_pesquisa;

{$R *.dfm}

procedure Tform_socios.edt_nomeKeyPress(Sender: TObject; var Key: Char);
begin
  if not (key in ['A'..'Z','a'..'z', #8, #32]) then
   key := #0;
end;

procedure Tform_socios.btn_localizarClick(Sender: TObject);
begin
  limpa_campos;
  bloqueia_campos;
  desabilita_salvar(Sender);

  form_pesquisa.sql_pesquisa :=
    'SELECT nome, CASE WHEN ativo = 1 THEN ''Ativo'' ELSE ''Inativo'' END AS status FROM sócios';
  form_pesquisa.ShowModal;

  if form_pesquisa.chave <> '' then
  begin
    pk := form_pesquisa.chave;
    ADOQuery_aux.SQL.Text := 'SELECT * FROM sócios WHERE nome = ' + QuotedStr(pk);
    ADOQuery_aux.Open;

    edt_nome.Text := ADOQuery_aux.FieldByName('nome').AsString;
    edt_renda.Text := ADOQuery_aux.FieldByName('renda').AsString;

    if ADOQuery_aux.FieldByName('ativo').AsBoolean then
      rd_ativo.Checked := True
    else
      rd_inativo.Checked := True;
  end;
end;


procedure Tform_socios.bloqueia_campos;
var
  i : integer;
begin
  for i := 1 to form_socios.ComponentCount -1 do
   begin
    if form_socios.Components[i] is TEdit then
     begin
      (form_socios.Components[i] as TEdit).Enabled := false;
      (form_socios.Components[i] as TEdit).Color := clinfobk;
     end;
end;
end;

procedure Tform_socios.desabilita_salvar(Sender: TObject);
begin

 btn_novo.Enabled := true;
 btn_salvar.Enabled := false;
 btn_alterar.Enabled := true;
 btn_cancelar.Enabled := false;
 btn_excluir.Enabled := true;

 if Sender = btn_novo then
  operacao := 'novo'
 else if Sender = btn_salvar then
  operacao := 'salvar'
 else if Sender = btn_alterar then
  operacao := 'alterar'
 else if Sender = btn_cancelar then
  operacao := 'cancelar'
 else if Sender = btn_excluir then
  operacao := 'excluir'

end;

procedure Tform_socios.habilita_salvar(Sender: TObject);
begin

  btn_novo.Enabled := false;
 btn_salvar.Enabled := true;
 btn_alterar.Enabled := false;
 btn_cancelar.Enabled := true;
 btn_excluir.Enabled := false;

 if Sender = btn_novo then
  operacao := 'novo'
 else if Sender = btn_salvar then
  operacao := 'salvar'
 else if Sender = btn_alterar then
  operacao := 'alterar'
 else if Sender = btn_cancelar then
  operacao := 'cancelar'
 else if Sender = btn_excluir then
  operacao := 'excluir'

end;

procedure Tform_socios.libera_campos;
var
  i : integer;
begin
  for i := 1 to form_socios.ComponentCount -1 do
   begin
    if form_socios.Components[i] is TEdit then
     begin
      (form_socios.Components[i] as TEdit).Enabled := true;
      (form_socios.Components[i] as TEdit).Color := clwindow;
     end;
end;

end;

procedure Tform_socios.limpa_campos;
var
  i : integer;
begin
  for i := 1 to form_socios.ComponentCount -1 do
   begin
    if form_socios.Components[i] is TEdit then
     begin
      (form_socios.Components[i] as TEdit).Clear;
     end;
end;
end;

procedure Tform_socios.FormShow(Sender: TObject);
begin
  bloqueia_campos;
  limpa_campos;
  desabilita_salvar(Sender);
  rd_ativo.Enabled := false;
  rd_inativo.Enabled := false;
end;

procedure Tform_socios.btn_novoClick(Sender: TObject);
begin
  limpa_campos;
  libera_campos;
  pk := '';
  habilita_salvar(Sender);
  rd_ativo.Enabled := true;
  rd_inativo.Enabled := true;
  rd_ativo.Checked := false;
  rd_inativo.Checked := false;

end;

procedure Tform_socios.btn_salvarClick(Sender: TObject);
var
  ativoValor: string;
  rendaValor: Double;
begin
  if (edt_nome.Text = '') or (edt_renda.Text = '') then
  begin
    ShowMessage('Preencha todos os campos');
    Exit;
  end;

  if Length(Trim(edt_nome.Text)) < 5 then
  begin
    ShowMessage('O nome deve ter pelo menos 5 letras!');
    Exit;
  end;

  if not TryStrToFloat(edt_renda.Text, rendaValor) then
  begin
    ShowMessage('Renda inválida! Digite apenas números.');
    Exit;
  end;

  if rendaValor < 0 then
  begin
    ShowMessage('Renda deve ser maior ou igual a zero!');
    Exit;
  end;

  if rd_ativo.Checked then
    ativoValor := 'TRUE'
  else
    ativoValor := 'FALSE';

  ADOQuery_aux.Close;
  ADOQuery_aux.SQL.Clear;

  if operacao = 'novo' then
    ADOQuery_aux.SQL.Text :=
      'INSERT INTO sócios (nome, renda, ativo) VALUES (' +
      QuotedStr(edt_nome.Text) + ', ' +
      FloatToStrF(rendaValor, ffFixed, 15, 2) + ', ' +
      ativoValor + ')'
  else if operacao = 'alterar' then
    ADOQuery_aux.SQL.Text :=
      'UPDATE sócios SET ' +
      'nome = ' + QuotedStr(edt_nome.Text) + ', ' +
      'renda = ' + FloatToStrF(rendaValor, ffFixed, 15, 2) + ', ' +
      'ativo = ' + ativoValor +
      ' WHERE nome = ' + QuotedStr(pk);

  ADOQuery_aux.ExecSQL;

  pk := edt_nome.Text;
  desabilita_salvar(Sender);
  bloqueia_campos;
  rd_ativo.Enabled := False;
  rd_inativo.Enabled := False;

end;

procedure Tform_socios.btn_cancelarClick(Sender: TObject);
begin
  if operacao = 'novo' then
   limpa_campos;


   desabilita_salvar(Sender);
   bloqueia_campos;
end;

procedure Tform_socios.btn_excluirClick(Sender: TObject);
begin
  if pk = '' then
   showmessage(' Impossivel excluir')
  else
   begin
    ADOQuery_aux.SQL.Text:=' DELETE FROM sócios ' +
                           ' WHERE nome = ' + QuotedStr(pk);

    ADOQuery_aux.ExecSQL;

    pk:='';
    desabilita_salvar(Sender);
    limpa_campos;
    bloqueia_campos;
    rd_ativo.Checked := false;
    rd_inativo.Checked := false;
   end;
end;

procedure Tform_socios.btn_alterarClick(Sender: TObject);
begin
  if pk = '' then
    ShowMessage('Impossível alterar')
  else
  begin
    libera_campos;
    habilita_salvar(Sender);
    rd_ativo.Enabled := True;
    rd_inativo.Enabled := True;
  end;
end;


end.

